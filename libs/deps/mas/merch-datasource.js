var y=window.adobeid?.authorize?.(),i={Authorization:`Bearer ${y}`,pragma:"no-cache","cache-control":"no-cache"};async function C({path:s,query:t,variant:o}){let e={};s&&(e.path=s),t&&(e.fullText={text:encodeURIComponent(t),queryMode:"EXACT_WORDS"});let c=new URLSearchParams({query:JSON.stringify({filter:e})}).toString();return fetch(`${this.cfSearchUrl}?${c}`,{headers:i}).then(n=>n.json()).then(n=>n.items).then(n=>o?n.filter(a=>{let[r]=a.fields.find(l=>l.name==="variant")?.values;return r===o}):n)}async function _(s){return fetch(`${this.cfFragmentsUrl}?path=${s}`,{headers:i}).then(t=>t.json()).then(({items:[t]})=>t)}var u=async s=>{let t=s.headers.get("Etag"),o=await s.json();return o.etag=t,o};async function E(s){return await fetch(`${this.cfFragmentsUrl}/${s}`,{headers:i}).then(u)}async function b(s){let{title:t,fields:o}=s;return await fetch(`${this.cfFragmentsUrl}/${s.id}`,{method:"PUT",headers:{"Content-Type":"application/json","If-Match":s.etag,...i},body:JSON.stringify({title:t,fields:o})}).then(u)}async function N(s){let t=await this.getCsrfToken(),o=s.path.split("/").pop(),e=s.path.split("/").slice(0,-1).join("/");if(/copy\s?\d?/.test(s.title)){let n=s.name.match(/copy\s?(\d)?/)[1]||1;o=s.name.replace(/copy\s?\d?/,`copy ${++n}`)}else o=`${o}-copy-1`;let c=new FormData;return c.append("cmd","copyPage"),c.append("srcPath",s.path),c.append("destParentPath",e),c.append("shallow","false"),c.append("_charset_","UTF-8"),c.append("destName",o),c.append("destTitle",s.title),await fetch(this.wcmcommandUrl,{method:"POST",headers:{...i,"csrf-token":t},body:c}).then(n=>{if(n.ok)return E(s.path)})}async function A(s){await fetch(this.cfPublishUrl,{method:"POST",headers:{"Content-Type":"application/json","If-Match":s.etag,...i},body:JSON.stringify({paths:[s.path],filterReferencesByStatus:["DRAFT","UNPUBLISHED"]})})}async function w(s){await fetch(`${this.cfFragmentsUrl}/${s.id}`,{method:"DELETE",headers:{"Content-Type":"application/json","If-Match":s.etag,...i}})}var d=class{async getCsrfToken(){let{token:t}=await fetch(this.csrfTokenUrl,{headers:i}).then(o=>o.json());return t}sites={cf:{fragments:{search:C.bind(this),getCfByPath:_.bind(this),getCfById:E.bind(this),save:b.bind(this),copyFragment:N.bind(this),publish:A.bind(this),delete:w.bind(this)}}};constructor(t){let o=`https://${t}.adobeaemcloud.com`,e=`${o}/adobe/sites`;this.cfFragmentsUrl=`${e}/cf/fragments`,this.cfSearchUrl=`${this.cfFragmentsUrl}/search`,this.cfPublishUrl=`${this.cfFragmentsUrl}/publish`,this.wcmcommandUrl=`${o}/bin/wcmcommand`,this.csrfTokenUrl=`${o}/libs/granite/csrf/token.json`}};function h(s,t={},o){let e=document.createElement(s);o instanceof HTMLElement?e.appendChild(o):e.innerHTML=o;for(let[c,n]of Object.entries(t))e.setAttribute(c,n);return e}var g="aem-bucket",M={catalog:{title:{tag:"h3",slot:"heading-xs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}},ah:{title:{tag:"h3",slot:"heading-xxs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xxs"},ctas:{size:"s"}},"ccd-action":{title:{tag:"h3",slot:"heading-xs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}},"special-offers":{name:{tag:"h4",slot:"detail-m"},title:{tag:"h4",slot:"detail-m"},backgroundImage:{tag:"div",slot:"bg-image"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}}};async function R(s,t,o){let e=s.fields.reduce((a,{name:r,multiple:l,values:p})=>(a[r]=l?p:p[0],a),{id:s.id});e.path=e.path,e.model=e.model;let{variant:c="catalog"}=e;o.setAttribute("variant",c);let n=M[c]??"catalog";if(e.icon?.forEach(a=>{let r=h("merch-icon",{slot:"icons",src:a,alt:"",href:"",size:"l"});t(r)}),e.title&&n.title&&t(h(n.title.tag,{slot:n.title.slot},e.title)),e.backgroundImage&&n.backgroundImage&&t(h(n.backgroundImage.tag,{slot:n.backgroundImage.slot},`<img loading="lazy" src="${e.backgroundImage}" width="600" height="362">`)),e.prices&&n.prices){let a=e.prices,r=h(n.prices.tag,{slot:n.prices.slot},a);t(r)}if(e.description&&n.description){let a=h(n.description.tag,{slot:n.description.slot},e.description);t(a)}if(e.ctas){let a=e.ctas,r=h("div",{slot:"footer"},a);[...r.querySelectorAll("a")].forEach(l=>{let p=h("sp-button",{},l);p.addEventListener("click",x=>{x.stopPropagation(),l.click()}),r.appendChild(p)}),t(r)}}var f=class{#t=new Map;clear(){this.#t.clear()}add(...t){t.forEach(o=>{let{path:e}=o;e&&this.#t.set(e,o)})}has(t){return this.#t.has(t)}get(t){return this.#t.get(t)}remove(t){this.#t.delete(t)}},T=new f,m=class extends HTMLElement{#t;cache=T;refs=[];path;static get observedAttributes(){return["source","path"]}attributeChangedCallback(t,o,e){this[t]=e}connectedCallback(){let t=this.getAttribute(g)??document.querySelector("mas-studio")?.getAttribute(g);this.#t=new d(t),this.fetchData()}refresh(t=!0){this.refs.forEach(o=>o.remove()),this.refs=[],t&&this.cache.remove(this.path),this.fetchData()}async fetchData(){let t=T.get(this.path);if(t||(t=await this.#t.sites.cf.fragments.getCfByPath(this.path)),t){R(t,e=>{this.parentElement.appendChild(e),this.refs.push(e)},this.parentElement);return}}};customElements.define("merch-datasource",m);export{m as MerchDataSource};
//# sourceMappingURL=merch-datasource.js.map
