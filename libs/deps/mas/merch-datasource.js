function g(d,t={},e){let a=document.createElement(d);e instanceof HTMLElement?a.appendChild(e):a.innerHTML=e;for(let[s,c]of Object.entries(t))a.setAttribute(s,c);return a}function T(d=1e3){return new Promise(t=>setTimeout(t,d))}var o=class extends Error{constructor(t,e={}){super(t),this.name="AEMError",this.details=e}},f=class{#t;constructor(t){this.#t=/^author-/.test(t);let e=`https://${t}.adobeaemcloud.com`,a=`${e}/adobe/sites`;this.cfFragmentsUrl=`${a}/cf/fragments`,this.cfSearchUrl=`${this.cfFragmentsUrl}/search`,this.cfPublishUrl=`${this.cfFragmentsUrl}/publish`,this.wcmcommandUrl=`${e}/bin/wcmcommand`,this.csrfTokenUrl=`${e}/libs/granite/csrf/token.json`,this.headers={Authorization:`Bearer ${sessionStorage.getItem("masAccessToken")??window.adobeid?.authorize?.()}`,pragma:"no-cache","cache-control":"no-cache"}}async getCsrfToken(){let t=await fetch(this.csrfTokenUrl,{headers:this.headers});if(!t.ok)throw new o(`Failed to get CSRF token: ${t.status} ${t.statusText}`);let{token:e}=await t.json();return e}async searchFragment({path:t,query:e,variant:a}){let s={};t&&(s.path=t),e&&(s.fullText={text:encodeURIComponent(e),queryMode:"EXACT_WORDS"});let c=new URLSearchParams({query:JSON.stringify({filter:s})}).toString(),i=await fetch(`${this.cfSearchUrl}?${c}`,{headers:this.headers});if(!i.ok)throw new o(`Search failed: ${i.status} ${i.statusText}`);let r=(await i.json()).items;return a&&(r=r.filter(h=>{let[l]=h.fields.find(m=>m.name==="variant")?.values;return l===a})),r}async getFragmentByPath(t){let e=this.#t?this.headers:{},a=await fetch(`${this.cfFragmentsUrl}?path=${t}`,{headers:e});if(!a.ok)throw new o(`Failed to get fragment: ${a.status} ${a.statusText}`);let{items:s}=await a.json();if(!s||s.length===0)throw new o("Fragment not found");return s[0]}async getFragment(t){let e=t.headers.get("Etag"),a=await t.json();return a.etag=e,a}async getFragmentById(t){let e=await fetch(`${this.cfFragmentsUrl}/${t}`,{headers:this.headers});if(!e.ok)throw new o(`Failed to get fragment: ${e.status} ${e.statusText}`);return await this.getFragment(e)}async saveFragment(t){let{title:e,fields:a}=t,s=await fetch(`${this.cfFragmentsUrl}/${t.id}`,{method:"PUT",headers:{"Content-Type":"application/json","If-Match":t.etag,...this.headers},body:JSON.stringify({title:e,fields:a})});if(!s.ok)throw new o(`Failed to save fragment: ${s.status} ${s.statusText}`);return await this.getFragment(s)}async copyFragmentClassic(t){let e=await this.getCsrfToken(),a=t.path.split("/").slice(0,-1).join("/"),s=new FormData;s.append("cmd","copyPage"),s.append("srcPath",t.path),s.append("destParentPath",a),s.append("shallow","false"),s.append("_charset_","UTF-8");let c=await fetch(this.wcmcommandUrl,{method:"POST",headers:{...this.headers,"csrf-token":e},body:s});if(!c.ok)throw new o(`Failed to copy fragment: ${c.status} ${c.statusText}`);let i=await c.text(),l=new DOMParser().parseFromString(i,"text/html").getElementById("Message")?.textContent.trim();if(!l)throw new o("Failed to extract new path from copy response");await T();let m=await this.getFragmentByPath(l);return m&&(m=await this.getFragmentById(m.id)),m}async publishFragment(t){let e=await fetch(this.cfPublishUrl,{method:"POST",headers:{"Content-Type":"application/json","If-Match":t.etag,...this.headers},body:JSON.stringify({paths:[t.path],filterReferencesByStatus:["DRAFT","UNPUBLISHED"],workflowModelId:"/var/workflow/models/scheduled_activation_with_references"})});if(!e.ok)throw new o(`Failed to publish fragment: ${e.status} ${e.statusText}`)}async deleteFragment(t){let e=await fetch(`${this.cfFragmentsUrl}/${t.id}`,{method:"DELETE",headers:{"Content-Type":"application/json","If-Match":t.etag,...this.headers}});if(!e.ok)throw new o(`Failed to delete fragment: ${e.status} ${e.statusText}`)}sites={cf:{fragments:{search:this.searchFragment.bind(this),getByPath:this.getFragmentByPath.bind(this),getById:this.getFragmentById.bind(this),save:this.saveFragment.bind(this),copy:this.copyFragmentClassic.bind(this),publish:this.publishFragment.bind(this),delete:this.deleteFragment.bind(this)}}}};var F="aem-bucket",p={CATALOG:"catalog",AH:"ah",CCD_ACTION:"ccd-action",SPECIAL_OFFERS:"special-offers"},$={[p.CATALOG]:{title:{tag:"h3",slot:"heading-xs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}},[p.AH]:{title:{tag:"h3",slot:"heading-xxs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xxs"},ctas:{size:"s"}},[p.CCD_ACTION]:{title:{tag:"h3",slot:"heading-xs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}},[p.SPECIAL_OFFERS]:{name:{tag:"h4",slot:"detail-m"},title:{tag:"h4",slot:"detail-m"},backgroundImage:{tag:"div",slot:"bg-image"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}}};async function k(d,t,e,a){let s=d.fields.reduce((n,{name:r,multiple:h,values:l})=>(n[r]=h?l:l[0],n),{id:d.id});s.model=s.model;let{variant:c="catalog"}=s;e.setAttribute("variant",c);let i=$[c]??"catalog";if(s.icon?.forEach(n=>{let r=g("merch-icon",{slot:"icons",src:n,alt:"",href:"",size:"l"});t(r)}),s.title&&i.title&&t(g(i.title.tag,{slot:i.title.slot},s.title)),s.backgroundImage&&i.backgroundImage&&t(g(i.backgroundImage.tag,{slot:i.backgroundImage.slot},`<img loading="lazy" src="${s.backgroundImage}" width="600" height="362">`)),s.prices&&i.prices){let n=s.prices,r=g(i.prices.tag,{slot:i.prices.slot},n);t(r)}if(s.description&&i.description){let n=g(i.description.tag,{slot:i.description.slot},s.description);t(n)}if(s.ctas){let n=g("div",{slot:"footer"},s.ctas),r=[];[...n.querySelectorAll("a")].forEach(h=>{let l=h.parentElement.tagName==="STRONG";if(a)h.classList.add("con-button"),l&&h.classList.add("blue"),r.push(h);else{let y=g("sp-button",{treatment:l?"fill":"outline",variant:l?"accent":"primary"},h);y.addEventListener("click",x=>{x.stopPropagation(),h.click()}),r.push(y)}}),n.innerHTML="",n.append(...r),t(n)}}var w=class{#t=new Map;clear(){this.#t.clear()}add(...t){t.forEach(e=>{let{path:a}=e;a&&this.#t.set(a,e)})}has(t){return this.#t.has(t)}get(t){return this.#t.get(t)}remove(t){this.#t.delete(t)}},u=new w,b=class extends HTMLElement{#t;cache=u;refs=[];path;consonant=!1;#e;static get observedAttributes(){return["source","path","consonant"]}attributeChangedCallback(t,e,a){this[t]=a}connectedCallback(){this.consonant=this.hasAttribute("consonant"),this.clearRefs();let t=this.getAttribute(F)??"publish-p22655-e59341";this.#t=new f(t),this.refresh(!1)}clearRefs(){this.refs.forEach(t=>{t.remove()})}async refresh(t=!0){this.path&&(this.#e&&!await Promise.race([this.#e,Promise.resolve(!1)])||(this.clearRefs(),this.refs=[],t&&this.cache.remove(this.path),this.#e=this.fetchData().then(()=>!0)))}async fetchData(){let t=u.get(this.path);if(t||(t=await this.#t.sites.cf.fragments.getByPath(this.path),u.add(t)),t){k(t,a=>{this.parentElement.appendChild(a),this.refs.push(a)},this.parentElement,this.consonant);return}}get updateComplete(){return this.#e??Promise.reject(new Error("datasource is not correctly configured"))}};customElements.define("merch-datasource",b);export{b as MerchDataSource};
