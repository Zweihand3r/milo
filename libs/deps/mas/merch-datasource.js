function l(c,t={},r){let e=document.createElement(c);r instanceof HTMLElement?e.appendChild(r):e.innerHTML=r;for(let[s,h]of Object.entries(t))e.setAttribute(s,h);return e}function u(c=1e3){return new Promise(t=>setTimeout(t,c))}var p=class{#t;constructor(t){this.#t=/^author-/.test(t);let r=`https://${t}.adobeaemcloud.com`,e=`${r}/adobe/sites`;this.cfFragmentsUrl=`${e}/cf/fragments`,this.cfSearchUrl=`${this.cfFragmentsUrl}/search`,this.cfPublishUrl=`${this.cfFragmentsUrl}/publish`,this.wcmcommandUrl=`${r}/bin/wcmcommand`,this.csrfTokenUrl=`${r}/libs/granite/csrf/token.json`,this.headers={Authorization:`Bearer ${sessionStorage.getItem("masAccessToken")??window.adobeid?.authorize?.()}`,pragma:"no-cache","cache-control":"no-cache"}}async getCsrfToken(){let{token:t}=await fetch(this.csrfTokenUrl,{headers:this.headers}).then(r=>r.json());return t}async searchFragment({path:t,query:r,variant:e}){let s={};t&&(s.path=t),r&&(s.fullText={text:encodeURIComponent(r),queryMode:"EXACT_WORDS"});let h=new URLSearchParams({query:JSON.stringify({filter:s})}).toString();return fetch(`${this.cfSearchUrl}?${h}`,{headers:this.headers}).then(a=>a.json()).then(a=>a.items).then(a=>e?a.filter(n=>{let[o]=n.fields.find(i=>i.name==="variant")?.values;return o===e}):a)}async getFragmentByPath(t){let r=this.#t?this.headers:{};return fetch(`${this.cfFragmentsUrl}?path=${t}`,{headers:r}).then(e=>e.json()).then(({items:[e]})=>e)}async getFragment(t){let r=t.headers.get("Etag"),e=await t.json();return e.etag=r,e}async getFragmentById(t){return await fetch(`${this.cfFragmentsUrl}/${t}`,{headers:this.headers}).then(this.getFragment)}async saveFragment(t){let{title:r,fields:e}=t;return await fetch(`${this.cfFragmentsUrl}/${t.id}`,{method:"PUT",headers:{"Content-Type":"application/json","If-Match":t.etag,...this.headers},body:JSON.stringify({title:r,fields:e})}).then(this.getFragment)}async copyFragmentClassic(t){let r=await this.getCsrfToken(),e=t.path.split("/").slice(0,-1).join("/"),s=new FormData;s.append("cmd","copyPage"),s.append("srcPath",t.path),s.append("destParentPath",e),s.append("shallow","false"),s.append("_charset_","UTF-8");let h=await fetch(this.wcmcommandUrl,{method:"POST",headers:{...this.headers,"csrf-token":r},body:s});if(h.ok){let a=await h.text(),d=new DOMParser().parseFromString(a,"text/html").getElementById("Message")?.textContent.trim();await u();let m=await this.getFragmentByPath(d);return m&&(m=await this.getFragmentById(m.id)),m}throw new Error("Failed to copy fragment")}async publishFragment(t){await fetch(this.cfPublishUrl,{method:"POST",headers:{"Content-Type":"application/json","If-Match":t.etag,...this.headers},body:JSON.stringify({paths:[t.path],filterReferencesByStatus:["DRAFT","UNPUBLISHED"],workflowModelId:"/var/workflow/models/scheduled_activation_with_references"})})}async deleteFragment(t){await fetch(`${this.cfFragmentsUrl}/${t.id}`,{method:"DELETE",headers:{"Content-Type":"application/json","If-Match":t.etag,...this.headers}})}sites={cf:{fragments:{search:this.searchFragment.bind(this),getByPath:this.getFragmentByPath.bind(this),getById:this.getFragmentById.bind(this),save:this.saveFragment.bind(this),copy:this.copyFragmentClassic.bind(this),publish:this.publishFragment.bind(this),delete:this.deleteFragment.bind(this)}}}};var T="aem-bucket",C={catalog:{title:{tag:"h3",slot:"heading-xs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}},ah:{title:{tag:"h3",slot:"heading-xxs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xxs"},ctas:{size:"s"}},"ccd-action":{title:{tag:"h3",slot:"heading-xs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}},"special-offers":{name:{tag:"h4",slot:"detail-m"},title:{tag:"h4",slot:"detail-m"},backgroundImage:{tag:"div",slot:"bg-image"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}}};async function x(c,t,r,e){let s=c.fields.reduce((n,{name:o,multiple:i,values:d})=>(n[o]=i?d:d[0],n),{id:c.id});s.path=s.path,s.model=s.model;let{variant:h="catalog"}=s;r.setAttribute("variant",h);let a=C[h]??"catalog";if(s.icon?.forEach(n=>{let o=l("merch-icon",{slot:"icons",src:n,alt:"",href:"",size:"l"});t(o)}),s.title&&a.title&&t(l(a.title.tag,{slot:a.title.slot},s.title)),s.backgroundImage&&a.backgroundImage&&t(l(a.backgroundImage.tag,{slot:a.backgroundImage.slot},`<img loading="lazy" src="${s.backgroundImage}" width="600" height="362">`)),s.prices&&a.prices){let n=s.prices,o=l(a.prices.tag,{slot:a.prices.slot},n);t(o)}if(s.description&&a.description){let n=l(a.description.tag,{slot:a.description.slot},s.description);t(n)}if(s.ctas){let n=s.ctas,o=l("div",{slot:"footer"},n);[...o.querySelectorAll("a")].forEach(i=>{if(e)i.classList.add("con-button"),i.parentElement.tagName==="STRONG"&&i.classList.add("blue"),o.appendChild(i);else{let d=l("sp-button",{},i);d.addEventListener("click",m=>{m.stopPropagation(),i.click()}),o.appendChild(d)}}),t(o)}}var f=class{#t=new Map;clear(){this.#t.clear()}add(...t){t.forEach(r=>{let{path:e}=r;e&&this.#t.set(e,r)})}has(t){return this.#t.has(t)}get(t){return this.#t.get(t)}remove(t){this.#t.delete(t)}},E=new f,g=class extends HTMLElement{#t;cache=E;refs=[];path;consonant=!1;#e;static get observedAttributes(){return["source","path","consonant"]}attributeChangedCallback(t,r,e){this[t]=e}connectedCallback(){this.consonant=this.hasAttribute("consonant"),this.clearRefs();let t=this.getAttribute(T)??"publish-p22655-e59341";this.#t=new p(t),this.refresh(!0)}clearRefs(){this.refs.forEach(t=>{t.remove()})}async refresh(t=!0){this.path&&(this.#e&&!await Promise.race([this.#e,Promise.resolve(!1)])||(this.clearRefs(),this.refs=[],t&&this.cache.remove(this.path),this.#e=this.fetchData().then(()=>!0)))}async fetchData(){let t=E.get(this.path);if(t||(t=await this.#t.sites.cf.fragments.getByPath(this.path)),t){x(t,e=>{this.parentElement.appendChild(e),this.refs.push(e)},this.parentElement,this.consonant);return}}get updateComplete(){return this.#e??Promise.reject(new Error("datasource is not correctly configured"))}};customElements.define("merch-datasource",g);export{g as MerchDataSource};
//# sourceMappingURL=merch-datasource.js.map
