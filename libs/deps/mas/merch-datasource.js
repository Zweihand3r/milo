function l(c,t={},a){let e=document.createElement(c);a instanceof HTMLElement?e.appendChild(a):e.innerHTML=a;for(let[s,h]of Object.entries(t))e.setAttribute(s,h);return e}function E(c=1e3){return new Promise(t=>setTimeout(t,c))}var g=class{#t;constructor(t){this.#t=/^author-/.test(t);let a=`https://${t}.adobeaemcloud.com`,e=`${a}/adobe/sites`;this.cfFragmentsUrl=`${e}/cf/fragments`,this.cfSearchUrl=`${this.cfFragmentsUrl}/search`,this.cfPublishUrl=`${this.cfFragmentsUrl}/publish`,this.wcmcommandUrl=`${a}/bin/wcmcommand`,this.csrfTokenUrl=`${a}/libs/granite/csrf/token.json`,this.headers={Authorization:`Bearer ${sessionStorage.getItem("masAccessToken")??window.adobeid?.authorize?.()}`,pragma:"no-cache","cache-control":"no-cache"}}async getCsrfToken(){let{token:t}=await fetch(this.csrfTokenUrl,{headers:this.headers}).then(a=>a.json());return t}async searchFragment({path:t,query:a,variant:e}){let s={};t&&(s.path=t),a&&(s.fullText={text:encodeURIComponent(a),queryMode:"EXACT_WORDS"});let h=new URLSearchParams({query:JSON.stringify({filter:s})}).toString();return fetch(`${this.cfSearchUrl}?${h}`,{headers:this.headers}).then(r=>r.json()).then(r=>r.items).then(r=>e?r.filter(n=>{let[o]=n.fields.find(i=>i.name==="variant")?.values;return o===e}):r)}async getFragmentByPath(t){let a=this.#t?this.headers:{};return fetch(`${this.cfFragmentsUrl}?path=${t}`,{headers:a}).then(e=>e.json()).then(({items:[e]})=>e)}async getFragment(t){let a=t.headers.get("Etag"),e=await t.json();return e.etag=a,e}async getFragmentById(t){return await fetch(`${this.cfFragmentsUrl}/${t}`,{headers:this.headers}).then(this.getFragment)}async saveFragment(t){let{title:a,fields:e}=t;return await fetch(`${this.cfFragmentsUrl}/${t.id}`,{method:"PUT",headers:{"Content-Type":"application/json","If-Match":t.etag,...this.headers},body:JSON.stringify({title:a,fields:e})}).then(this.getFragment)}async copyFragmentClassic(t){let a=await this.getCsrfToken(),e=t.path.split("/").slice(0,-1).join("/"),s=new FormData;s.append("cmd","copyPage"),s.append("srcPath",t.path),s.append("destParentPath",e),s.append("shallow","false"),s.append("_charset_","UTF-8");let h=await fetch(this.wcmcommandUrl,{method:"POST",headers:{...this.headers,"csrf-token":a},body:s});if(h.ok){let r=await h.text(),d=new DOMParser().parseFromString(r,"text/html").getElementById("Message")?.textContent.trim();await E();let m=await this.getFragmentByPath(d);return m&&(m=await this.getFragmentById(m.id)),m}throw new Error("Failed to copy fragment")}async publishFragment(t){await fetch(this.cfPublishUrl,{method:"POST",headers:{"Content-Type":"application/json","If-Match":t.etag,...this.headers},body:JSON.stringify({paths:[t.path],filterReferencesByStatus:["DRAFT","UNPUBLISHED"],workflowModelId:"/var/workflow/models/scheduled_activation_with_references"})})}async deleteFragment(t){await fetch(`${this.cfFragmentsUrl}/${t.id}`,{method:"DELETE",headers:{"Content-Type":"application/json","If-Match":t.etag,...this.headers}})}sites={cf:{fragments:{search:this.searchFragment.bind(this),getByPath:this.getFragmentByPath.bind(this),getById:this.getFragmentById.bind(this),save:this.saveFragment.bind(this),copy:this.copyFragmentClassic.bind(this),publish:this.publishFragment.bind(this),delete:this.deleteFragment.bind(this)}}}};var u="aem-bucket",x={catalog:{title:{tag:"h3",slot:"heading-xs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}},ah:{title:{tag:"h3",slot:"heading-xxs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xxs"},ctas:{size:"s"}},"ccd-action":{title:{tag:"h3",slot:"heading-xs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}},"special-offers":{name:{tag:"h4",slot:"detail-m"},title:{tag:"h4",slot:"detail-m"},backgroundImage:{tag:"div",slot:"bg-image"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}}};async function C(c,t,a,e){let s=c.fields.reduce((n,{name:o,multiple:i,values:d})=>(n[o]=i?d:d[0],n),{id:c.id});s.path=s.path,s.model=s.model;let{variant:h="catalog"}=s;a.setAttribute("variant",h);let r=x[h]??"catalog";if(s.icon?.forEach(n=>{let o=l("merch-icon",{slot:"icons",src:n,alt:"",href:"",size:"l"});t(o)}),s.title&&r.title&&t(l(r.title.tag,{slot:r.title.slot},s.title)),s.backgroundImage&&r.backgroundImage&&t(l(r.backgroundImage.tag,{slot:r.backgroundImage.slot},`<img loading="lazy" src="${s.backgroundImage}" width="600" height="362">`)),s.prices&&r.prices){let n=s.prices,o=l(r.prices.tag,{slot:r.prices.slot},n);t(o)}if(s.description&&r.description){let n=l(r.description.tag,{slot:r.description.slot},s.description);t(n)}if(s.ctas){let n=s.ctas,o=l("div",{slot:"footer"},n);[...o.querySelectorAll("a")].forEach(i=>{if(e)i.classList.add("con-button"),i.parentElement.tagName==="STRONG"&&i.classList.add("blue"),o.appendChild(i);else{let d=l("sp-button",{},i);d.addEventListener("click",m=>{m.stopPropagation(),i.click()}),o.appendChild(d)}}),t(o)}}var p=class{#t=new Map;clear(){this.#t.clear()}add(...t){t.forEach(a=>{let{path:e}=a;e&&this.#t.set(e,a)})}has(t){return this.#t.has(t)}get(t){return this.#t.get(t)}remove(t){this.#t.delete(t)}},T=new p,f=class extends HTMLElement{#t;cache=T;refs=[];path;consonant=!1;static get observedAttributes(){return["source","path","consonant"]}attributeChangedCallback(t,a,e){this[t]=e}connectedCallback(){this.consonant=this.hasAttribute("consonant"),this.clearRefs();let t=this.getAttribute(u)??document.querySelector("mas-studio")?.getAttribute(u)??"publish-p22655-e59341";this.#t=new g(t),this.fetchData()}clearRefs(){this.refs.forEach(t=>{t.remove()})}refresh(t=!0){this.clearRefs(),this.refs=[],t&&this.cache.remove(this.path),this.fetchData()}async fetchData(){let t=T.get(this.path);if(t||(t=await this.#t.sites.cf.fragments.getByPath(this.path)),t){C(t,e=>{this.parentElement.appendChild(e),this.refs.push(e)},this.parentElement,this.consonant);return}}};customElements.define("merch-datasource",f);export{f as MerchDataSource};
//# sourceMappingURL=merch-datasource.js.map
