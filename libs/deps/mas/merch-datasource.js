var C=window.adobeid?.authorize?.(),l={Authorization:`Bearer ${C}`,pragma:"no-cache","cache-control":"no-cache"};async function y({path:o,query:t,variant:s}){let e={};o&&(e.path=o),t&&(e.fullText={text:encodeURIComponent(t),queryMode:"EXACT_WORDS"});let n=new URLSearchParams({query:JSON.stringify({filter:e})}).toString();return fetch(`${this.cfSearchUrl}?${n}`,{headers:l}).then(c=>c.json()).then(c=>c.items).then(c=>s?c.filter(r=>{let[a]=r.fields.find(h=>h.name==="variant")?.values;return a===s}):c)}async function _(o){return fetch(`${this.cfFragmentsUrl}?path=${o}`,{headers:l}).then(t=>t.json()).then(({items:[t]})=>t)}var E=async o=>{let t=o.headers.get("Etag"),s=await o.json();return s.etag=t,s};async function u(o){return await fetch(`${this.cfFragmentsUrl}/${o}`,{headers:l}).then(E)}async function b(o){let{title:t,fields:s}=o;return await fetch(`${this.cfFragmentsUrl}/${o.id}`,{method:"PUT",headers:{"Content-Type":"application/json","If-Match":o.etag,...l},body:JSON.stringify({title:t,fields:s})}).then(E)}async function N(o){let t=await this.getCsrfToken(),s=o.path.split("/").pop(),e=o.path.split("/").slice(0,-1).join("/");if(/copy\s?\d?/.test(o.title)){let c=o.name.match(/copy\s?(\d)?/)[1]||1;s=o.name.replace(/copy\s?\d?/,`copy ${++c}`)}else s=`${s}-copy-1`;let n=new FormData;return n.append("cmd","copyPage"),n.append("srcPath",o.path),n.append("destParentPath",e),n.append("shallow","false"),n.append("_charset_","UTF-8"),n.append("destName",s),n.append("destTitle",o.title),await fetch(this.wcmcommandUrl,{method:"POST",headers:{...l,"csrf-token":t},body:n}).then(c=>{if(c.ok)return u(o.path)})}var p=class{async getCsrfToken(){let{token:t}=await fetch(this.csrfTokenUrl,{headers:l}).then(s=>s.json());return t}sites={cf:{fragments:{search:y.bind(this),getCfByPath:_.bind(this),getCfById:u.bind(this),save:b.bind(this),copyFragment:N.bind(this)}}};constructor(t){let s=`https://${t}.adobeaemcloud.com`,e=`${s}/adobe/sites`;this.cfFragmentsUrl=`${e}/cf/fragments`,this.cfSearchUrl=`${this.cfFragmentsUrl}/search`,this.wcmcommandUrl=`${s}/bin/wcmcommand`,this.csrfTokenUrl=`${s}/libs/granite/csrf/token.json`}};function i(o,t={},s){let e=document.createElement(o);s instanceof HTMLElement?e.appendChild(s):e.innerHTML=s;for(let[n,c]of Object.entries(t))e.setAttribute(n,c);return e}var g="aem-bucket",A={catalog:{title:{tag:"h3",slot:"heading-xs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}},ah:{title:{tag:"h3",slot:"heading-xxs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xxs"},ctas:{size:"s"}},"ccd-action":{title:{tag:"h3",slot:"heading-xs"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}},"special-offers":{name:{tag:"h4",slot:"detail-m"},title:{tag:"h4",slot:"detail-m"},backgroundImage:{tag:"div",slot:"bg-image"},prices:{tag:"h3",slot:"heading-xs"},description:{tag:"div",slot:"body-xs"},ctas:{size:"l"}}};async function w(o,t,s){let e=o.fields.reduce((r,{name:a,multiple:h,values:d})=>(r[a]=h?d:d[0],r),{id:o.id});e.path=e.path,e.model=e.model;let{variant:n="catalog"}=e;s.setAttribute("variant",n);let c=A[n]??"catalog";if(e.icon?.forEach(r=>{let a=i("merch-icon",{slot:"icons",src:r,alt:"",href:"",size:"l"});t(a)}),e.title&&c.title&&t(i(c.title.tag,{slot:c.title.slot},e.title)),e.backgroundImage&&c.backgroundImage&&t(i(c.backgroundImage.tag,{slot:c.backgroundImage.slot},`<img loading="lazy" src="${e.backgroundImage}" width="600" height="362">`)),e.prices&&c.prices){let r=e.prices,a=i(c.prices.tag,{slot:c.prices.slot},r);t(a)}if(e.description&&c.description){let r=i(c.description.tag,{slot:c.description.slot},e.description);t(r)}if(e.ctas){let r=e.ctas,a=i("div",{slot:"footer"},r);[...a.querySelectorAll("a")].forEach(h=>{let d=i("sp-button",{},h);d.addEventListener("click",x=>{x.stopPropagation(),h.click()}),a.appendChild(d)}),t(a)}}var m=class{#t=new Map;clear(){this.#t.clear()}add(...t){t.forEach(s=>{let{path:e}=s;e&&this.#t.set(e,s)})}has(t){return this.#t.has(t)}get(t){return this.#t.get(t)}remove(t){this.#t.delete(t)}},T=new m,f=class extends HTMLElement{#t;cache=T;refs=[];path;static get observedAttributes(){return["source","path"]}attributeChangedCallback(t,s,e){this[t]=e}connectedCallback(){let t=this.getAttribute(g)??document.querySelector("mas-studio")?.getAttribute(g);this.#t=new p(t),this.fetchData()}refresh(t=!0){this.refs.forEach(s=>s.remove()),this.refs=[],t&&this.cache.remove(this.path),this.fetchData()}async fetchData(){let t=T.get(this.path);if(t||(t=await this.#t.sites.cf.fragments.getCfByPath(this.path)),t){w(t,e=>{this.parentElement.appendChild(e),this.refs.push(e)},this.parentElement);return}}};customElements.define("merch-datasource",f);export{f as MerchDataSource};
//# sourceMappingURL=merch-datasource.js.map
