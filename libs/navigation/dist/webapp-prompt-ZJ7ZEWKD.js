import{G as y,b as P,d as p,g as c,i as d}from"./chunk-MSFBWOG7.js";import"./chunk-6BOSLXEP.js";import{a as u,c as f}from"./chunk-3ELCGEYD.js";import"./chunk-WT37DKJ5.js";import{f as g,q as v}from"./chunk-7TJA6U3A.js";import"./chunk-YBWLHNHN.js";var D={animationCount:2,animationDuration:2500,tooltipMessage:"Use the App Switcher to quickly find apps.",tooltipDuration:5e3},a={selectors:{prompt:".appPrompt"},delay:7e3,loaderColor:"#EB1000",...D},w=s=>s?.textContent?.trim(),S=s=>[...s.childNodes].reduce((t,i)=>{if(i.children?.length===2){let e=w(i.children[0]),o=w(i.children[1]);e&&o&&(t[e]=o)}return t},{}),T=s=>{let t=s.querySelector("picture");if(t)return t;let i=s.querySelector('a[href$=".svg"]');return i?v(i):P.company},I=(s,t=a.tooltipMessage,i=a.tooltipDuration)=>{s.setAttribute("data-pep-dismissal-tooltip",t);let e=()=>s.removeAttribute("data-pep-dismissal-tooltip"),o=setTimeout(e,i);s.addEventListener("click",()=>{e(),clearTimeout(o)},{once:!0})},L=(s,t=a.animationCount,i=a.animationDuration)=>{s.classList.add("coach-indicator"),s.style.setProperty("--animation-duration",`${i}ms`);let e=[],o=()=>c`
    <div
      class="coach-indicator-ring"
      style="animation-iteration-count: ${t};">
    </div>`;for(let r=0;r<3;r+=1){let h=o();s.insertAdjacentElement("afterbegin",h),e.push(h)}let n=()=>{e.forEach(r=>r.remove()),s.classList.remove("coach-indicator")},l=setTimeout(n,(t+1)*i);s.addEventListener("click",()=>{n(),clearTimeout(l)},{once:!0})},E=()=>!!document.querySelector(".dialog-modal"),$=s=>{if(E()){setTimeout(()=>$(s),200);return}s()},m=class s{constructor({promptPath:t,entName:i,parent:e,getAnchorState:o}={}){if(this.promptPath=t,this.entName=i,this.parent=e,this.getAnchorState=o,this.id=this.promptPath.split("/").pop(),this.elements={},E()){window.addEventListener("milo:modal:closed",()=>$(this.init),{once:!0}),this.initializationQueued=!0;return}this.initializationQueued=!1}init=async()=>{if(this.isDismissedPrompt()||!this.parent||!(new URLSearchParams(window.location.search).get("skipPepEntitlements")||await this.doesEntitlementMatch()))return;let e=await this.fetchContent();e&&(await this.getData(e),!(!this.options["redirect-url"]||!this.options["product-name"])&&({id:this.anchorId,isOpen:this.isAnchorExpanded}=await this.getAnchorState().catch(o=>(p({message:"Error on getting anchor state",e:o,tags:"errorType=error,module=pep"}),{})),!this.isAnchorExpanded&&(this.anchorId&&(this.anchor=document.querySelector(`#${this.anchorId}`)),this.offset=this.anchor?this.parent.offsetWidth-(this.anchor.offsetWidth+this.anchor.offsetLeft):0,this.template=this.decorate(),this.addEventListeners(),this.parent.prepend(this.template),this.elements.closeIcon.focus(),this.redirectFn=this.initRedirect())))};doesEntitlementMatch=async()=>{let i=await g().entitlements();return new URLSearchParams(window.location.search).get("mockPepEnts")?.split(",").forEach(o=>i.push(o.trim())),i?.length&&i.includes(this.entName)};fetchContent=async()=>{let t=await fetch(`${this.promptPath}.plain.html`);if(!t.ok)return p({message:`Error fetching content for prompt: ${this.promptPath}.plain.html`,e:`Status ${t.status} when trying to fetch content for prompt`,tags:"errorType=error,module=pep"}),"";let i=await t.text(),e=await f(i,d());return new DOMParser().parseFromString(e,"text/html")};getData=async t=>{this.icon=T(t);let i={title:"h2",subtitle:"h3",cancel:"em > a"};await Promise.all(Object.keys(i).map(async o=>{let n=t.querySelector(i[o]);if(n?.innerText)this[o]=n.innerText;else{let l=await u(`pep-prompt-${o}`,d());this[o]=l===`pep prompt ${o}`?"":l}})),await y().then(o=>{["display_name","email","avatar"].every(r=>!!o[r])&&(this.profile=o)}).catch(o=>{p({message:"Error fetching user profile",e:o,tags:"errorType=error,module=pep"})});let e=S(t.querySelector(".section-metadata"));e["loader-duration"]=parseInt(e["loader-duration"]||a.delay,10),e["loader-color"]=e["loader-color"]||a.loaderColor,e["dismissal-animation-count"]=parseInt(e["dismissal-animation-count"]??a.animationCount,10),e["dismissal-animation-duration"]=parseInt(e["dismissal-animation-duration"]??a.animationDuration,10),e["dismissal-tooltip-message"]??=a.tooltipMessage,e["dismissal-tooltip-duration"]=parseInt(e["dismissal-tooltip-duration"]??a.tooltipDuration,10),this.options=e};decorate=()=>(this.elements.closeIcon=c`<button daa-ll="Close Modal" aria-label="${this.cancel}" class="appPrompt-close"></button>`,this.elements.cta=c`<button daa-ll="Stay on this page" class="appPrompt-cta appPrompt-cta--close">${this.cancel}</button>`,this.elements.profile=this.profile?c`<div class="appPrompt-profile">
        <div class="appPrompt-avatar">
          <img class="appPrompt-avatar-image" src="${this.profile.avatar}" />
        </div>
        <div class="appPrompt-user">
          <div class="appPrompt-name">${this.profile.display_name}</div>
          <div class="appPrompt-email">${this.profile.email}</div>
        </div>
      </div>`:"",c`<div
      daa-state="true" daa-im="true" daa-lh="PEP Modal_${this.options["product-name"]?.toLowerCase()}"
      class="appPrompt" style="margin: 0 ${this.offset}px">
      ${this.elements.closeIcon}
      <div class="appPrompt-icon">
        ${this.icon}
      </div>
      <div class="appPrompt-title">${this.title}</div>
      ${this.elements.profile}
      <div class="appPrompt-footer">
        <div class="appPrompt-text">${this.subtitle}</div>
        ${this.elements.cta}
      </div>
      <div class="appPrompt-progressWrapper">
        <div class="appPrompt-progress" style="background-color: ${this.options["loader-color"]}; animation-duration: ${this.options["loader-duration"]}ms;"></div>
      </div>
    </div>`);addEventListeners=()=>{this.anchor?.addEventListener("click",()=>this.close({dismissalActions:!1})),document.addEventListener("keydown",this.handleKeyDown),[this.elements.closeIcon,this.elements.cta].forEach(t=>t.addEventListener("click",this.close))};handleKeyDown=t=>{t.key==="Escape"&&this.close()};static redirectTo(t){window.location.assign(t)}initRedirect=()=>setTimeout(()=>{this.close({saveDismissal:!1,dismissalActions:!1}),s.redirectTo(this.options["redirect-url"])},this.options["loader-duration"]);isDismissedPrompt=()=>s.getDismissedPrompts().includes(this.id);setDismissedPrompt=()=>{let t=new Set(s.getDismissedPrompts());t.add(this.id),document.cookie=`dismissedAppPrompts=${JSON.stringify([...t])};path=/`};close=({saveDismissal:t=!0,dismissalActions:i=!0}={})=>{document.querySelector(a.selectors.prompt)?.remove(),clearTimeout(this.redirectFn),t&&this.setDismissedPrompt(),document.removeEventListener("keydown",this.handleKeyDown),this.anchor?.focus(),this.anchor?.removeEventListener("click",this.close),i&&(L(this.anchor,this.options["dismissal-animation-count"],this.options["dismissal-animation-duration"]),I(this.anchor,this.options["dismissal-tooltip-message"],this.options["dismissal-tooltip-duration"]))};static getDismissedPrompts=()=>{let t=document.cookie.split(";").find(i=>i.trim().startsWith("dismissedAppPrompts="))?.split("=")[1];return t?JSON.parse(t):[]}};async function x(s){try{let t=new m(s);return t.initializationQueued||await t.init(),t}catch(t){return p({message:"Could not initialize PEP",e:t,tags:"errorType=error,module=pep"}),null}}export{m as AppPrompt,D as DISMISSAL_CONFIG,x as default};
